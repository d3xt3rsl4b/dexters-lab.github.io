<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>Decrypting Mirai configuration With radare2 (Part 1) - Tainted Bits</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Tainted Bits"><meta name="msapplication-TileImage" content="/images/logo-header.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Tainted Bits"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="This is the second part of the three-part series about code Emulation for Reversing Malware :Part 1 describes how to use radare2 function emulation along with an exercise of cracking password of funct"><meta property="og:type" content="article"><meta property="og:title" content="Decrypting Mirai configuration With radare2 (Part 1)"><meta property="og:url" content="https://www.taintedbits.com/2018/09/03/decrypting-mirai-configuration-with-radare2-part-1/"><meta property="og:site_name" content="Tainted Bits"><meta property="og:description" content="This is the second part of the three-part series about code Emulation for Reversing Malware :Part 1 describes how to use radare2 function emulation along with an exercise of cracking password of funct"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://www.taintedbits.com/images/malware-reverse-engg-thumbnail.jpg"><meta property="article:published_time" content="2018-09-03T10:36:23.000Z"><meta property="article:modified_time" content="2021-03-11T10:27:20.873Z"><meta property="article:author" content="D3xt3r"><meta property="article:tag" content="Malware Analysis"><meta property="article:tag" content="Linux Malware"><meta property="article:tag" content="radare2"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/images/malware-reverse-engg-thumbnail.jpg"><meta property="twitter:creator" content="@0xd3xt3r"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.taintedbits.com/2018/09/03/decrypting-mirai-configuration-with-radare2-part-1/"},"headline":"Tainted Bits","image":["https://www.taintedbits.com/images/malware-reverse-engg-thumbnail.jpg"],"datePublished":"2018-09-03T10:36:23.000Z","dateModified":"2021-03-11T10:27:20.873Z","author":{"@type":"Person","name":"D3xt3r"},"description":"This is the second part of the three-part series about code Emulation for Reversing Malware :Part 1 describes how to use radare2 function emulation along with an exercise of cracking password of funct"}</script><link rel="alternate" href="/atom.xml" title="Tainted Bits" type="application/atom+xml"><link rel="icon" href="/images/logo-header.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/railscasts.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-128181439-1" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-128181439-1")</script><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/logo-header.png" alt="Tainted Bits" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/publications">Publication</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/0xd3xt3r"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time datetime="2018-09-03T10:36:23.000Z" title="9/3/2018, 4:06:23 PM">2018-09-03</time></span><span class="level-item">Updated&nbsp;<time datetime="2021-03-11T10:27:20.873Z" title="3/11/2021, 3:57:20 PM">2021-03-11</time></span><span class="level-item"><a class="link-muted" href="/categories/Reverse-Engineering/">Reverse Engineering</a></span><span class="level-item">25 minutes read (About 3732 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Decrypting Mirai configuration With radare2 (Part 1)</h1><div class="content"><p>This is the <em>second part</em> of the three-part series about code Emulation for Reversing Malware :<br><strong><a href="/2018/08/15/emulating-decryption-function-with-radare2/" title="Part 1">Part 1</a></strong> describes how to use radare2 function emulation along with an exercise of cracking password of function implemented using radare2 python scripting plugin r2pipe.<br><strong><a href="/2018/09/03/decrypting-mirai-configuration-with-radare2-part-1/" title="Part 2">Part 2</a></strong> describes how to use the feature to decode a configuration of a Mirai IOT botnet, by implementing the solution in radare python scripting capabilities.<br><strong><a href="/2018/09/15/decrypting-mirai-configuration-with-radare2-part-2/" title="Part 3">Part 3</a></strong> improves the script created in the previous by adding more features of searching for addresses of encrypted string and creating function signature to search for decryption function instead of using the hard-coded address of the function.</p><p>In the <a href="/2018/08/15/emulating-decryption-function-with-radare2/" title="previous post">previous post</a> we looked at how to we can use partial code emulation to decrypt a string in a binary. In this post we will take an example of a popular Linux IOT malware Mirai, the reason for choosing this particular malware is it stores its configuration like CNC server, port etc in encrypted form. Mirai botnet is cross-architecture so for this post we will reverse the x86 architecture version of the binary. The main goal of this post is to automate the configuration decryption using radare2. We will also use radare2 for static analysis of the binary and to reverse a little bit of decryption function.</p><span id="more"></span><p>To those who have not of the heard about Mirai before, it’s IOT botnet which infects the networked Linux devices once it has installed itself it then uses the infected device as DOS attacking medium. This malware can be cross-compiled across different architecture such as x64, SPARC, MIPS, ARM etc. Another dangerous aspect of this Malware is that the author has released the source code due to which there are lots script-kiddies using this malware either as its or they are developing a variant of it. This another reason if felt the need to create the script to automation the decryption of configuration. You can find the source of the malware on <a target="_blank" rel="noopener" href="https://github.com/jgamblin/Mirai-Source-Code">this GitHub repository</a>.</p><h2 id="Malware-File"><a href="#Malware-File" class="headerlink" title="Malware File"></a>Malware File</h2><p>I am using following files for this analysis, Surprisingly this sample was using the same source code which I pointed out earlier. But for the rest of the post, we will analyze the binary as if didn’t have the source code.</p><table><thead><tr><th>File SHA 1 hash</th><th>File Name</th></tr></thead><tbody><tr><td>318998d8ad1e5a9be588ecccf9713c42788c9972</td><td>mirai-telnet.x86</td></tr><tr><td>a7c901114b6c767562c32d30c9f6a076a380a767</td><td>mirai-ssh.x86</td></tr></tbody></table><h2 id="Find-the-encryption-function"><a href="#Find-the-encryption-function" class="headerlink" title="Find the encryption function"></a>Find the encryption function</h2><p>Malware author usually uses a very simple operation like XOR, bit shifting(SHR or SHL) or bit rotating(ROR or ROL) to encrypt strings. The algorithm is usually a combination of this operations. So to search for encryption function we can search for these instructions, radare2 has opcode search functionality you can see all the available options with <strong>/a?</strong> command.</p><p>For our particular case <strong>/at xor</strong> will find all the address at which xor instruction is present, this command search a particular family of instruction like and, or, push, etc are the other family of instruction. To get the list of all family of instruction type <strong>/atl</strong> command.</p><p>If you search for xor instruction you will find 226 hits and there were lots of instruction in which register as XORed with itself which is very common for normal code, this instruction is used to set the register to 0, we are looking for xor instruction whose source and destination operand is different. We can also do the similar search for <strong>shr</strong> and <strong>shl</strong> bit shift operation and <strong>ror</strong> and <strong>rol</strong> bit rotate operation. With lots of searches, there was a function starting at <strong>0x804d680</strong> which had a high concentration of these kinds of operation. Let reverse this function.</p><h2 id="Reversing-the-decryption-function"><a href="#Reversing-the-decryption-function" class="headerlink" title="Reversing the decryption function"></a>Reversing the decryption function</h2><p>Let’s try to understand the decryption function a bit about the function how it gets the input parameters, as a high-level understanding is required to understand the parameters which the function is manipulating the internally.</p><p>Open the visual mode with <strong>VV</strong> command, this will the graph of the decryption function and you can toggle through different graph view by pressing <strong>p</strong>. We will use this view to understand the detail of the decryption function.</p><img src="/2018/09/03/decrypting-mirai-configuration-with-radare2-part-1/decrypt-function-overview.png" title="Figure A : Overview of Decryption function"><p>This is a general pattern of string decryption functions that you can see here, first there is some setup of the string pointer, then the register which will be loaded with the decryption key, and then there will be the loop which will do the decryption of the string, there was also a crackme which I came across which first decrypted the decryption key and then the data was decrypted with that key, just another layer of protection but the technique remains the same. The decryption key may be passed through the function parameter or may be stored in the function local variable or in the global variable.</p><p>Before we look into reversing the function lets try to understand radare visual mode which we are using, in particular, the graph view we are currently in. This view represents the assembly code in a graph view (like IDA) but the code is collapsed instead only this connection between different node is shown either with a red/blue/green line, each of this color has a meaning. Blue color means this jump is unconditional, green means the jump is taken if the condition is true and red means the jump is taken if the condition is false. Each node is shown with a hex value of the address of the starting of the code of that particular node, the entire address is not shown, just a small part of it is displayed. There is also some alphabet shown in the square bracket in yellow color, that is the keys you have to press to read the code of that node. So in the screen above you can press <strong>gc</strong> to see the code for **<strong>d6a0</strong>** node. If you do so that node will be shown as <strong>&lt;@@@@@@&gt;</strong>, this represents the current node whose code is displayed on the left side. This view gives us the high-level flow of the code, just by looking at this view you can see the loops and if else statement of the function. You can use arrow keys to move the graph around on the screen. Now that we know a little bit about this functionality lets use it to analyze the decryption function.</p><p>Looking at the graph we can see the pattern we discussed before, first the initialization in the first two nodes on the left side and then an unconditional jump to the loop function. There is also a conditional jump on the root node if the condition is true then the jump is taken at the end of the function, this must be some sort of validation of the parameter, if the validation is true then function cannot run the decryption and if the validation is false then the function does some additional initialization and then jumps to loop (which might be the real meat).</p><p>In this function you can see the initialization code in the left side, ebp, edi, esi and ebx registers are pushed on to stack and the value 0x1c is subtracted from esp, we see two things happening here, the registers are push on to stack to preserve their old value which we expect restored to old values by popping them back to the old values at the end of the function. Secondly, the subtracting of 0x1c value from the stack is done to allocate local variable in the function. we can verify this by switching to the node with <strong>[ga]</strong> you will see the assembly code of exit node as below.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[0x804d66a]</span><br><span class="line">add esp, 0x1c</span><br><span class="line">pop ebx</span><br><span class="line">pop esi</span><br><span class="line">pop edi</span><br><span class="line">pop ebp</span><br><span class="line">ret</span><br></pre></td></tr></table></figure><p>The values of the registers are popped back and the esp is torn down by adding 0x1c value. Next xor instruction sets the value of eax to zero and next the register <strong>al</strong> is set to the value of the first argument addressed by <strong>esp + 0x30</strong> strange the function parameter is addressed using esp register rather then ebp register, this is the only parameter which is passed to the function according to the radare, we expected to pass as two parameters, string to obfuscate and the decryption key, but instead there is only one parameter which is of byte size integer which means that the value of parameter ranges from 0 to 31, the combination of previous two instruction do something really interesting, xor set the entire eax to zero and next set the lower 8-bit value to argument passed to the function. Next inst is <strong>lea ecx, [eax*8 + 0x8052800]</strong>, lea instruction is usually used to calculate address, this instruction is using <strong>base + index*size</strong> format of addressing, eax register is the index which is passed as parameter to the function and <strong>0x8052800</strong> is the base address and the size is 8 byte, this instruction reveal a lot about the configuration of the bot. First of all, the configuration is an array of a data structure of size 8 byte ( maybe the structure has two members of size 4 byte) the base address of the structure and the indexing is pretty clear.</p><p>Next inst <strong>mov eax, dword [0x80526fc]</strong> loads the value at address <strong>0x80526fc</strong> into EAX this instruction is not clear for now, next few instruction might help use. Next instruction is comparison the <strong>cmp word [ecx + 4], 0</strong>, ecx was loaded with the address of data structure and <strong>ecx + 4</strong> is the second member of structure which is of size word (2 bytes) and is compared with zero and if it’s zero then jumps to exit node of the function. Next, let’s look at the false branch <strong>[gc]</strong> of the comparison instruction.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0x804d620 [gc]</span><br><span class="line">mov edi, eax</span><br><span class="line">mov esi, eax</span><br><span class="line">mov ebp, eax</span><br><span class="line">xor edx, edx</span><br><span class="line">shr eax, 0x18</span><br><span class="line">shr edi, 8</span><br><span class="line">mov byte [esp], al</span><br><span class="line">shr esi, 0x10</span><br></pre></td></tr></table></figure><p>On this node copies of eax register is made onto other registers edi, esi and ebp register and later bit shift right operation of 8, 0x18 and 0x10 are performed respectively. EAX register as we can understand so far here is that another data in been used in this function which is not clear what it is. Lower 8 bits of EAX register(AL) are copied on the top of the stack. Moving on to the next node <strong>[gd]</strong>.</p><img src="/2018/09/03/decrypting-mirai-configuration-with-radare2-part-1/decryption-function-meat.png" title="Figure A : Real meat of decryption function"><p>On this node there are lots of xor instruction, this is probably the real meat of the function as we can see the last instruction which is a comparison instruction who’s true branch go to the starting of this same node and the false branch exist the function. The ecx register is not changed so far in the register which to recall is loaded with the base address of the struct of 8 bytes. The first instruction this node moves the value of pointing by ecx into ebx, this first member of the struct seems to be a pointer, maybe a char pointer (char*). Next the copy of the ebx register is made into eax, next eax and edx (which is 0 at this point) is added to eax and result is stored in eax and ebx is loaded with ebp which is the copy of data at address <strong>0x80526fc</strong>(may be a key) and then <strong>xor byte [eax], bl</strong> instruction value at address eax is xored with bl register and value is stored back at the address pointed by eax register. So far we can make a safe assumption that value at address <strong>0x80526fc</strong> is the key which is used for decryption. Rest of the instruction in this node are all based on register, no other other external data is loaded.</p><p>We should now look for the termination condition of this loop, in the end, the node eax register is compared with edx register. EDX is not changed to any other value before except for increase itself by 1, edx register was earlier set to zero we can say that edx is the counter of the loop. The counter is compared with eax register which is set to value pointed by <strong>ecx + 4</strong> if you recall ecx register is not altered to any other value is still holds the base address of the data structure, eax register is set to the second member of the struct and then it is compared with 0xffff which means the upper 16 bits of the eax register is set to 0 which is another hint the 2nd member of struct is 2 byte, which we can conclude that 2nd member is the length of the string we want to decrypt which of 2 bytes. Lets not reversed this function any further and let us see if we can get any meaningful results out of this to understand so far if we fail we come back at this function and reverse it further.</p><h2 id="Emulating-the-decryption-function"><a href="#Emulating-the-decryption-function" class="headerlink" title="Emulating the decryption function"></a>Emulating the decryption function</h2><p>Now that we have a fair bit of understanding about the decryption function, let’s try to emulate for one string and then automate the decryption for any given string. There are a couple of conclusions that can be drawn from the reversing session before which are :</p><ol><li>We expected to get two parameters to the function decryption key and the data to decryption which is not the case.</li><li>The parameter pass is in the index of the configuration the bot want to decrypt which then loads the base address of the data structure into ecx register which remains unchanged through the rest of the function.</li><li>The decryption key is part of the function which is read from the global variable.</li><li>Function manipulates the data structure which has two members, first member, being the char pointer to the encrypted string and 2nd member is 16-bit int member which is the length of the encrypted string.</li></ol><p>To execute the function we need to do the following :</p><ol><li>Allocate a memory and copy the encrypted string to that memory.</li><li>Create the config data structure and set the first member of the address of the encrypted string which we just copied on the stack and the 2nd member is set to the appropriate length.</li><li>Start the execution of the emulator from the first instruction of the function and then halt the execution at the point where the ecx is loaded with the base address of the data structure and instead set the ecx register with the address of the config data structure which we created earlier.</li><li>Then continue the execution of the function until the last instruction of the function and then print the decrypted string as a null-terminated string.</li></ol><p>To get all the string in the binary we can use <strong>ps @@ str.*</strong> command. Since the string is encrypted, they might not be null terminated as during encryption the null value can be in the middle of the legitimate string and radare might fail to identify string and its proper length during auto-analysis. To mitigate this we will consider all the string of length 100 even if radare marks its less then 100 and copy the 100 bytes in the memory and then decrypt the string, but when we print the string we will print the string as a null-terminated string which can be less then 100 bytes. The string could be longer than 100 bytes, in that case, we will come back to the script and change length. For example, for we can consider anyone strings for emulation, I have considered string starting at address <strong>0x08050ecd</strong>.</p><p>Below are the radare commands to execute the emulation :</p><ol><li><strong>s 0x804d680</strong>: Seek to the starting of the function.</li><li><strong>y 100 @ 0x08050ecd</strong>: Copy 100 bytes of the string starting at address <strong>0x08050ecd</strong> in radare clipboard.</li><li><strong>aei ; aeim ; aeip</strong>: Initialization of emulation engine, create the memory and set the register values. Memory created starts at address 0x100000.</li><li><strong>yy @ 0x100000</strong>: This command will paste the copied data start at the address 0x100000, this is the address of the string we are going to use for emulation.</li><li><strong>wx 0x00001000 @ 0x100064</strong>: This command creates the first member of the config data structure with the address of encrypted data. The base address of the config data structure is 0x100064. The value <strong>0x00001000</strong> is 4 bytes for a little-endian format for <strong>0x100000</strong> which is the address of the encrypted string we just copied.</li><li><strong>wv 100 @ 0x100068</strong>: This command sets the 2nd member of the data structure with the length of encrypted string which is the constant value 100 for our experiment, at this point, we have created the config data structure.</li><li><strong>aecu 0x804d694</strong>: This command starts the execution of the function till the address 0x804d694, this is the point where we want to change to value of ecx register to the address of data structure.</li><li><strong>ar ecx=0x100064</strong>: Change the value of ecx register with the address of the data structure we have created above.</li><li><strong>aecu 0x0804d6f0</strong>: This command continues the execution until the end of the function. At this point, the string is decrypted and we should be able to print a null-terminated string.</li><li><strong>ps @ 0x100000</strong> : This command print the null-terminated string starting at address 0x100000.</li></ol><p>Running this command you should be able to see the output shown below. You can even create the above commands as a macro and pass the address of the string as the parameter to the macro to see the output, copy paste the below code to create the macro.</p><img src="/2018/09/03/decrypting-mirai-configuration-with-radare2-part-1/emulation-output.png" title="Figure C : Decryption Emulation output"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(mirai_decrypt flg, s 0x804d680, y 100 @ <span class="variable">$0</span>, aei, aeim, aeip, yy @ 0x100000, wx 0x00001000 @ 0x100064, wv 100 @ 0x100068, aecu 0x0804d694, ar ecx=0x100064, aecu 0x0804d6f0, ps @ 0x100000)</span><br></pre></td></tr></table></figure><p>The above command will create the macro named <strong>mirai_decrypt</strong> to use the macro issue the command <strong>.(mirai_decrypte<addr of the string>)</addr></strong>. What we just did is decryption of just one string the goal of this post was to really automate this decryption of all configuration of the bot which ideally will be a python script that takes binary as a parameter and should display the whole config. To achieve this we should create a python script using this same commands an above, python script is as below.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> r2pipe</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">r = r2pipe.<span class="built_in">open</span>(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">r.cmd(<span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">func_start_addr = <span class="string">&#x27;0x804d680&#x27;</span></span><br><span class="line"><span class="comment"># to load the appropriate value of data structure of in the register</span></span><br><span class="line">addr_of_halt = <span class="string">&#x27;0x804d694&#x27;</span></span><br><span class="line">func_end_addr = <span class="string">&#x27;0x0804d6f0&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">emu_decrypt</span>(<span class="params">str_offset, str_len=<span class="number">100</span></span>):</span></span><br><span class="line">    r.cmd(<span class="string">&#x27;s &#x27;</span>+ func_start_addr)</span><br><span class="line">    r.cmd(<span class="string">&#x27;y &#123;&#125; @ &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(str_len, str_offset))</span><br><span class="line">    r.cmd(<span class="string">&#x27;aei&#x27;</span>)</span><br><span class="line">    r.cmd(<span class="string">&#x27;aeim&#x27;</span>)</span><br><span class="line">    r.cmd(<span class="string">&#x27;aeip&#x27;</span>)</span><br><span class="line">    r.cmd(<span class="string">&#x27;aer&#x27;</span>)</span><br><span class="line">    r.cmd(<span class="string">&#x27;yy @ 0x100000&#x27;</span>)</span><br><span class="line">    r.cmd(<span class="string">&#x27;wx 0x00001000 @ 0x100064&#x27;</span>)</span><br><span class="line">    r.cmd(<span class="string">&#x27;wv &#123;&#125; @ 0x100068&#x27;</span>.<span class="built_in">format</span>(str_len))</span><br><span class="line">    r.cmd(<span class="string">&#x27;aecu &#x27;</span>+addr_of_halt)</span><br><span class="line">    r.cmd(<span class="string">&#x27;ar ecx=0x100064&#x27;</span>)</span><br><span class="line">    r.cmd(<span class="string">&#x27;aecu &#x27;</span>+func_end_addr)</span><br><span class="line">    <span class="keyword">return</span> r.cmd(<span class="string">&#x27;ps @ 0x100000)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;String : &#x27;</span> + emu_decrypt(<span class="string">&#x27;0x804d680&#x27;</span>))</span><br></pre></td></tr></table></figure><p>This script should have the same effect as above macro you should be able to see the decrypted string printed. Next step should be to enumerate the address of all the strings and pass those address as the parameter to the <strong>emu_decrypt</strong> function. You can get the list of all strings by using <strong>ps @@ str.*</strong> command, we will use this command to get the address of all string in python code which is as follows.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> str_obj <span class="keyword">in</span> r.cmd(<span class="string">&#x27;psj 1 @@ str.*&#x27;</span>).split(<span class="string">&#x27;\n&#x27;</span>):</span><br><span class="line">    str_obj = json.loads(str_obj)</span><br><span class="line">    dcrypt_offset = <span class="built_in">str</span>(str_obj[<span class="string">&#x27;offset&#x27;</span>])</span><br><span class="line">    print(emu_decrypt(dcrypt_offset))</span><br></pre></td></tr></table></figure><p>Once you run the script you will the output as below. As you can see there are lots of meaningful decrypted strings and I am sure that’s not all the configuration, as there are other garbage hex value been printed. Maybe radare is not able to find all the encrypted strings as they might look completely like normal binary hex value after encryption so radare doesn’t flag them as strings, we need another way to figure out the reference to this bot configuration strings.</p><p>The next problem we have to tackle the problem of finding all the address of the encrypted string, once that is done we can the python function we created above to decrypt the string. Finding those addresses was not that simple as I thought, nonetheless it helps me to discover other capabilities of radare which put to use to tackle the challenge.</p><p>The output of the decryption python script is as follow.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">I@MVJLLVJMVJIOxrxxxxyxzantari.duckdns.org</span><br><span class="line">OGISyourdady.duckdns.org</span><br><span class="line">t/tcp</span><br><span class="line">ttp</span><br><span class="line">c/cpuinfo</span><br><span class="line">BOGOMIPS</span><br><span class="line">tc/rc.d/rc.local</span><br><span class="line">/rc.local</span><br><span class="line">/FTWDT101_watchdog</span><br><span class="line">/FTWDT101 watchdog</span><br><span class="line">WsGA4@F6F</span><br><span class="line">ACDB</span><br><span class="line">PRIVMSG</span><br><span class="line">GETLOCALIP</span><br><span class="line">KILLATTK</span><br><span class="line">ppp\x15\x09\x0ezu9&gt;4w9=3uZxshell</span><br><span class="line">u9&gt;4w9=3uZxshell</span><br><span class="line">9=3uZxshell</span><br><span class="line">tc/resolv.conf</span><br><span class="line">ps</span><br><span class="line">-9</span><br><span class="line">0PP2rRkIoK6qyZO166</span><br><span class="line">ZO166</span><br><span class="line">pW\x1c\x1d\x0eW\x16\x0d\x14\x14xxx</span><br></pre></td></tr></table></figure><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>I think to a certain extent we have able to accomplish the goal, we were able to decrypt the bot configuration as you would have observed some domain names and other meaningful string. But the goal is not completely achieved we will address the problem of finding the reference to the encrypted string in the next post, as it requires addition reversing of the binary. We also saw how partial function emulation can be helpful and save our time on not writing the decryption function and with a little bit of understanding of encryption function you can emulate the code and get the benefits of decryption. In the next post, we will improve the above script to find all the configuration references and decrypt it.</p><p>This is <a target="_blank" rel="noopener" href="https://github.com/0xd3xt3r/blog-code/tree/master/decrypting-mirai-configuration-with-radare2">GitHub link</a> of the above python script we created, it has the full solution implemented. The sample files mentioned above are available on request to the researchers, please send me an email from your work email id to confirm your identity. Thank you for reading this post.</p></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Malware-Analysis/">Malware Analysis</a><a class="link-muted mr-2" rel="tag" href="/tags/Linux-Malware/">Linux Malware</a><a class="link-muted mr-2" rel="tag" href="/tags/radare2/">radare2</a></div></article></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2018/09/15/decrypting-mirai-configuration-with-radare2-part-2/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Decrypting Mirai configuration With radare2 (Part 2)</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2018/09/02/reversing-bushido-iot-botnet-by-zullsec/"><span class="level-item">Reversing Bushido IOT botnet by ZullSec</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config=function(){this.page.url="https://www.taintedbits.com/2018/09/03/decrypting-mirai-configuration-with-radare2-part-1/",this.page.identifier="2018/09/03/decrypting-mirai-configuration-with-radare2-part-1/"};!function(){var t=document,i=t.createElement("script");i.src="//taintedbits.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(i)}()</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen order-1"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Malware-File"><span class="level-left"><span class="level-item">1</span><span class="level-item">Malware File</span></span></a></li><li><a class="level is-mobile" href="#Find-the-encryption-function"><span class="level-left"><span class="level-item">2</span><span class="level-item">Find the encryption function</span></span></a></li><li><a class="level is-mobile" href="#Reversing-the-decryption-function"><span class="level-left"><span class="level-item">3</span><span class="level-item">Reversing the decryption function</span></span></a></li><li><a class="level is-mobile" href="#Emulating-the-decryption-function"><span class="level-left"><span class="level-item">4</span><span class="level-item">Emulating the decryption function</span></span></a></li><li><a class="level is-mobile" href="#Conclusion"><span class="level-left"><span class="level-item">5</span><span class="level-item">Conclusion</span></span></a></li></ul></div></div><style>#toc .menu-list>li>a.is-active+.menu-list{display:block}#toc .menu-list>li>a+.menu-list{display:none}</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time datetime="2021-02-14T18:30:00.000Z">2021-02-15</time></p><p class="title"><a href="/2021/02/15/arm-architecture-webinar/">ARM Architecture and Shellcode Webinars</a></p><p class="categories"><a href="/categories/Binary-Exploitation/">Binary Exploitation</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2020-06-06T18:30:00.000Z">2020-06-07</time></p><p class="title"><a href="/2020/06/07/binary-exploitation-pwnable-kr-level-6/">Binary Exploitation [pwnable.kr] - (Level 6) random</a></p><p class="categories"><a href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2020-06-05T18:30:00.000Z">2020-06-06</time></p><p class="title"><a href="/2020/06/06/binary-exploitation-pwnable-kr-level-5/">Binary Exploitation [pwnable.kr] - (Level 5) passcode</a></p><p class="categories"><a href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2020-05-16T18:30:00.000Z">2020-05-17</time></p><p class="title"><a href="/2020/05/17/binary-exploitation-pwnable-kr-level-4/">Binary Exploitation [pwnable.kr] - (Level 4) flag</a></p><p class="categories"><a href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2020-05-15T18:30:00.000Z">2020-05-16</time></p><p class="title"><a href="/2020/05/16/binary-exploitation-pwnable-kr-level-3/">Binary Exploitation [pwnable.kr] - (Level 3) BOF</a></p><p class="categories"><a href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Binary-Exploitation/"><span class="level-start"><span class="level-item">Binary Exploitation</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Brain-Logs/"><span class="level-start"><span class="level-item">Brain Logs</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/CTF-Writeups/"><span class="level-start"><span class="level-item">CTF Writeups</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/Exploitation/"><span class="level-start"><span class="level-item">Exploitation</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/IoT/"><span class="level-start"><span class="level-item">IoT</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Machine-Learning/"><span class="level-start"><span class="level-item">Machine Learning</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Malware-Analysis/"><span class="level-start"><span class="level-item">Malware Analysis</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/NLP/"><span class="level-start"><span class="level-item">NLP</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Reverse-Engineering/"><span class="level-start"><span class="level-item">Reverse Engineering</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ACS712/"><span class="tag">ACS712</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Arduino/"><span class="tag">Arduino</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Bare-Metal/"><span class="tag">Bare-Metal</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Chat-Bots/"><span class="tag">Chat Bots</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Classification/"><span class="tag">Classification</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Data-Wrangling/"><span class="tag">Data Wrangling</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Dev/"><span class="tag">Dev</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Dropper/"><span class="tag">Dropper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ESP8266/"><span class="tag">ESP8266</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Editor/"><span class="tag">Editor</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Emacs/"><span class="tag">Emacs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Exploitation/"><span class="tag">Exploitation</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GandCrab/"><span class="tag">GandCrab</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Grey-Energy/"><span class="tag">Grey Energy</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kernel-Debugging/"><span class="tag">Kernel Debugging</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux-Malware/"><span class="tag">Linux Malware</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Malware-Analysis/"><span class="tag">Malware Analysis</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Regression/"><span class="tag">Regression</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reverse-Engineering/"><span class="tag">Reverse Engineering</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Visualization/"><span class="tag">Visualization</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows-Malware/"><span class="tag">Windows Malware</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows-Reversing/"><span class="tag">Windows Reversing</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/glibc/"><span class="tag">glibc</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/javascript-obfuscation/"><span class="tag">javascript obfuscation</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable/"><span class="tag">pwnable</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable-kr/"><span class="tag">pwnable-kr</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/radare2/"><span class="tag">radare2</span><span class="tag">4</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/logo-header.png" alt="Tainted Bits" height="28"></a><p class="is-size-7"><span>&copy; 2021 D3xt3r</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by-sa/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Subscribe" href="https://mailchi.mp/d744c1f04904/taintedbits"><i class="fa fa-envelope"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/0xd3xt3r"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en")</script><script>var IcarusThemeSettings={article:{highlight:{clipboard:!0,fold:"unfolded"}}}</script><script src="/js/column.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load",()=>{"function"==typeof $.fn.lightGallery&&$(".article").lightGallery({selector:".gallery-item"}),"function"==typeof $.fn.justifiedGallery&&($(".justified-gallery > p > .gallery-item").length&&$(".justified-gallery > p > .gallery-item").unwrap(),$(".justified-gallery").justifiedGallery())})</script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now</a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load",(function(){outdatedBrowser({bgColor:"#f25648",color:"#ffffff",lowerThan:"object-fit"})}))</script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener("DOMContentLoaded",(function(){loadInsight({contentUrl:"/content.json"},{hint:"Type something...",untitled:"(Untitled)",posts:"Posts",pages:"Pages",categories:"Categories",tags:"Tags"})}))</script></body></html>