<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>Decrypting Mirai configuration With radare2 (Part 2) - Tainted Bits</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Tainted Bits"><meta name="msapplication-TileImage" content="/images/logo-header.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Tainted Bits"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="This is the third part of the three-part series about code Emulation for Reversing Malware :Part 1 describes how to use radare2 function emulation along with an exercise of cracking password of functi"><meta property="og:type" content="article"><meta property="og:title" content="Decrypting Mirai configuration With radare2 (Part 2)"><meta property="og:url" content="https://www.taintedbits.com/2018/09/15/decrypting-mirai-configuration-with-radare2-part-2/"><meta property="og:site_name" content="Tainted Bits"><meta property="og:description" content="This is the third part of the three-part series about code Emulation for Reversing Malware :Part 1 describes how to use radare2 function emulation along with an exercise of cracking password of functi"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://www.taintedbits.com/images/malware-reverse-engg-thumbnail.jpg"><meta property="article:published_time" content="2018-09-15T10:36:23.000Z"><meta property="article:modified_time" content="2021-03-11T10:27:20.873Z"><meta property="article:author" content="D3xt3r"><meta property="article:tag" content="Malware Analysis"><meta property="article:tag" content="Linux Malware"><meta property="article:tag" content="radare2"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/images/malware-reverse-engg-thumbnail.jpg"><meta property="twitter:creator" content="@0xd3xt3r"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.taintedbits.com/2018/09/15/decrypting-mirai-configuration-with-radare2-part-2/"},"headline":"Tainted Bits","image":["https://www.taintedbits.com/images/malware-reverse-engg-thumbnail.jpg"],"datePublished":"2018-09-15T10:36:23.000Z","dateModified":"2021-03-11T10:27:20.873Z","author":{"@type":"Person","name":"D3xt3r"},"description":"This is the third part of the three-part series about code Emulation for Reversing Malware :Part 1 describes how to use radare2 function emulation along with an exercise of cracking password of functi"}</script><link rel="alternate" href="/atom.xml" title="Tainted Bits" type="application/atom+xml"><link rel="icon" href="/images/logo-header.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/railscasts.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-128181439-1" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-128181439-1")</script><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/logo-header.png" alt="Tainted Bits" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/publications">Publication</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/0xd3xt3r"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time datetime="2018-09-15T10:36:23.000Z" title="9/15/2018, 4:06:23 PM">2018-09-15</time></span><span class="level-item">Updated&nbsp;<time datetime="2021-03-11T10:27:20.873Z" title="3/11/2021, 3:57:20 PM">2021-03-11</time></span><span class="level-item"><a class="link-muted" href="/categories/Reverse-Engineering/">Reverse Engineering</a></span><span class="level-item">15 minutes read (About 2314 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Decrypting Mirai configuration With radare2 (Part 2)</h1><div class="content"><p>This is the <em>third part</em> of the three-part series about code Emulation for Reversing Malware :<br><strong><a href="/2018/08/15/emulating-decryption-function-with-radare2/" title="Part 1">Part 1</a></strong> describes how to use radare2 function emulation along with an exercise of cracking password of function implemented using radare2 python scripting plugin r2pipe.<br><strong><a href="/2018/09/03/decrypting-mirai-configuration-with-radare2-part-1/" title="Part 2">Part 2</a></strong> describes how to use the feature to decode a configuration of a Mirai IOT botnet, by implementing the solution in radare python scripting capabilities.<br><strong><a href="/2018/09/15/decrypting-mirai-configuration-with-radare2-part-2/" title="Part 3">Part 3</a></strong> improves the script created in the previous by adding more features of searching for addresses of encrypted string and creating function signature to search for decryption function instead of using the hard-coded address of the function.</p><p>In the previous two posts we looked at how to emulate a string decryption function call and we created a radare2 macro and python script to use that emulation, we also managed to decrypt some configuration, but not all. In this post we will continue to improve the script, we will continue with the problem finding the address of encrypted data in the previous post and use those address to decrypt the configuration. There another interesting problem I came across when testing this script on the other variant of Mirai samples, the decryption function was not present at the same address as in the previous binary, all thought the function implementation was the same, well I managed to fix that by creating function signature other cool feature of radare. We will also explore many other features improve the script and make it more portable such that if the sample is using the same decryption method then our python script should be able to decrypt the configuration. Let get right into it.</p><span id="more"></span><h2 id="Data-Reference-Search-Method"><a href="#Data-Reference-Search-Method" class="headerlink" title="Data Reference Search Method"></a>Data Reference Search Method</h2><p>If you have paid a close attention to the reversing of the encryption function in the previous post, you would have argued that we took the wrong approach of decrypting the configuration, instead of setting the configuration struct on stack and changing the register values we could have just past the configuration index as argument and the rest would have been taken care by the function emulation. I would agree with you, but that would be true if the whole array of structures was already in place at that memory, but that was not the case. These array of the data structure is created at run-time. Let’s see in radare what is present at that location address <em>0x08052800</em> which is the base address of the data structure.</p><img src="/2018/09/15/decrypting-mirai-configuration-with-radare2-part-2/data-structure-references.png" title="Figure A: Data view at the address"><p>As you can see there are lots of references round this memory location pointed out by <strong>DATA XREFS from<function name></function></strong>there is lots of reference from <strong>sub.7_1_700</strong>(address 0x804d700), let’s see what’s there.</p><img src="/2018/09/15/decrypting-mirai-configuration-with-radare2-part-2/fcn-loading-data-structure.png" title="Figure B: Function referenced by the data structure"><p>As you can see there are lots of references to global data, maybe its copying the encrypted string and its length. You can see this pattern push one byte and push the global reference address and push register and call to a function. coping string from one location to other location and the length is passed as parameter let disassemble that function (address 0x0804e0f0).</p><img src="/2018/09/15/decrypting-mirai-configuration-with-radare2-part-2/custom-memory-copy-function.png" title="Figure C : Custom Memory copy function"><p>Maybe this function(address 0x0804e0f0) coping string from one location to other location and the length is passed as a parameter. As you can see there is a loop and this loop is coping byte from <strong>edx + ebx</strong> to <strong>edx + esi</strong> edx been the loop counter variable. So we can conclude that this is a memory copy function. Question is why not use the standard library memory copy function? that because standard library function might not be available on all Linux environment remember this malware is trying to run on all the possible devices running Linux, not all environment might not have the luxury of libc standard functions, there might be many other such functions which mimic the standard C run-time function. Let’s go back to the function we came from.</p><p>Now that we know that there are global data been referenced from this function lets find all the data reference form this function and see if using these addresses we can get any meaningful string. To get all the data references from this function we can use <strong>agaj</strong> command this will give us the result in json format. This command returns the global referenced address in the title field of the json and we are not interested in other fields. Below is the python code to iterate this json and run decryption function on these global references.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># start address of the function sub.7_1_700</span></span><br><span class="line">config_addr_start = <span class="string">&#x27;0x0804d700&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># end address of the function sub.7_1_700</span></span><br><span class="line">config_addr_end = <span class="string">&#x27;0x0804e080&#x27;</span></span><br><span class="line"></span><br><span class="line">r.cmd(<span class="string">&#x27;s &#x27;</span>+config_addr_start)</span><br><span class="line"></span><br><span class="line"><span class="comment"># data references as json array</span></span><br><span class="line">data_refs = r.cmdj(<span class="string">&#x27;agaj&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># get all the address as array from the title field of the json</span></span><br><span class="line">data_refs = <span class="built_in">map</span>(<span class="keyword">lambda</span> y : y[<span class="string">&#x27;title&#x27;</span>], data_refs[<span class="string">&#x27;nodes&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> str_addr <span class="keyword">in</span> data_refs:</span><br><span class="line">    print(emu_decrypt(str_addr))</span><br></pre></td></tr></table></figure><p>This is the output we get.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">+\xfb\x94l\x12l\x90\x8doxx\xfb\xbct\xf1\xbb\x12l\x10\xc0v&#125;p(\x90\xab</span><br><span class="line">zantari.duckdns.org</span><br><span class="line">OGISyourdady.duckdns.org</span><br><span class="line">\x15\xb3x\xfc\xa1xKuasa Menjejaskan Anda</span><br><span class="line">\xfc\xa1xKuasa Menjejaskan Anda</span><br><span class="line">Kuasa Menjejaskan Anda</span><br><span class="line">/proc/</span><br><span class="line">/exe</span><br><span class="line">/fd</span><br><span class="line">/proc/net/tcp</span><br><span class="line">/maps</span><br><span class="line">/status</span><br><span class="line">.anime</span><br><span class="line">/proc/net/route</span><br><span class="line">/proc/cpuinfo</span><br><span class="line">BOGOMIPS</span><br><span class="line">/etc/rc.d/rc.local</span><br><span class="line">g1abc4dmo35hnp2lie0kjf</span><br><span class="line">assword</span><br><span class="line">/dev/watchdog</span><br><span class="line">/dev/misc/watchdog</span><br><span class="line">/dev/FTWDT101_watchdog</span><br><span class="line">/dev/FTWDT101 watchdog</span><br><span class="line">/dev/netslink/</span><br></pre></td></tr></table></figure><p>As you can see there are lots of meaningful string like <em>domain names, /proc/*</em> etc which were not decrypted by earlier string reference method. But there are other configurations which were present in the previous method but not in this method, that means we still don’t have the full configuration we can use the combination of both the method or we could try another method as shown in the next section.</p><h2 id="Assembly-Search-Method"><a href="#Assembly-Search-Method" class="headerlink" title="Assembly Search Method"></a>Assembly Search Method</h2><p>Earlier we saw there was a push, push, push and call pattern to copy the encrypted string from one address to another we could find all the push instruction and extract the address from that instruction and try to decrypt the data at that address. Again, we can use the instruction search functionality which we used in the previous post to find all the push type of instruction, for that we will use <strong>/atj push</strong> to search all push function and return the result in json format.</p><p>Before searching we first have to adjust the limit of search to just this function or else radare2 will search push instruction in whole binary we can do that with <strong>e search.to</strong> and <strong>e search.from</strong> configuration. We will set the <em>from</em> and <em>to</em> of configuration to start and end of function respectively. Below is the python code to do what we just discussed.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># start address of the function sub.7_1_700</span></span><br><span class="line">config_addr_start = <span class="string">&#x27;0x0804d700&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># end address of the function sub.7_1_700</span></span><br><span class="line">config_addr_end = <span class="string">&#x27;0x0804e080&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># adjust the limit of search</span></span><br><span class="line">r.cmd(<span class="string">&#x27;e search.from = &#x27;</span>+config_addr_start)</span><br><span class="line">r.cmd(<span class="string">&#x27;e search.to = &#x27;</span>+config_addr_end)</span><br><span class="line"></span><br><span class="line">push_list = r.cmdj(<span class="string">&#x27;/atj push&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> inst <span class="keyword">in</span> push_list:</span><br><span class="line">    <span class="keyword">if</span> inst[<span class="string">&#x27;size&#x27;</span>] == <span class="number">5</span> :</span><br><span class="line">        data_offset = inst[<span class="string">&#x27;opstr&#x27;</span>].replace(<span class="string">&#x27;push &#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        print(emu_decrypt(data_offset))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>the output of this method is as below.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">zantari.duckdns.org</span><br><span class="line">OGISyourdady.duckdns.org</span><br><span class="line">\x15\xb3x\xfc\xa1xKuasa Menjejaskan Anda</span><br><span class="line">\xfc\xa1xKuasa Menjejaskan Anda</span><br><span class="line">Kuasa Menjejaskan Anda</span><br><span class="line">/proc/</span><br><span class="line">/exe</span><br><span class="line">/fd</span><br><span class="line">/proc/net/tcp</span><br><span class="line">/maps</span><br><span class="line">/status</span><br><span class="line">.anime</span><br><span class="line">/proc/net/route</span><br><span class="line">/proc/cpuinfo</span><br><span class="line">BOGOMIPS</span><br><span class="line">/etc/rc.d/rc.local</span><br><span class="line">g1abc4dmo35hnp2lie0kjf</span><br><span class="line">assword</span><br><span class="line">/dev/watchdog</span><br><span class="line">/dev/misc/watchdog</span><br><span class="line">/dev/FTWDT101_watchdog</span><br><span class="line">/dev/FTWDT101 watchdog</span><br><span class="line">/dev/netslink/</span><br><span class="line">V[Ov</span><br><span class="line">WsGA4@F6F</span><br><span class="line">ACDB</span><br><span class="line">AbAd</span><br><span class="line">iaGv</span><br><span class="line">PRIVMSG</span><br><span class="line">GETLOCALIP</span><br><span class="line">KILLATTK</span><br><span class="line">Eats8</span><br><span class="line">/proc/self/exe</span><br><span class="line">\x15\x09\x0ezu9&gt;4w9=3uZxshell</span><br><span class="line">shell</span><br><span class="line"><span class="built_in">enable</span></span><br><span class="line">system</span><br><span class="line">sh</span><br><span class="line">/bin/busybox kkuuaassaa</span><br><span class="line">kkuuaassaa: applet not found</span><br><span class="line">ncorrect</span><br><span class="line">assword</span><br><span class="line">ogin</span><br><span class="line">enter</span><br><span class="line">/bin/busybox ps</span><br><span class="line">/bin/busybox <span class="built_in">kill</span> -9</span><br><span class="line">TSource Engine Query</span><br><span class="line">/etc/resolv.conf</span><br><span class="line">nameserver</span><br><span class="line">/dev/watchdog</span><br><span class="line">/dev/misc/watchdog</span><br><span class="line">ox0PP2rRkIoK6qyZO166</span><br><span class="line">dvrHelper</span><br><span class="line">http</span><br></pre></td></tr></table></figure><p>As you can see there are lots of meaningful string this time we can see strings that were not present in both the earlier methods like busybox commands etc. Seems like push, push pattern is the best method. Now that we are able to decrypt the data let now move the focus to make this script more portable i.e. try to remove the hardcoded address of the function and try to search those methods in the binary and used the discovered address instead.</p><h2 id="Creating-and-searching-a-function-signature"><a href="#Creating-and-searching-a-function-signature" class="headerlink" title="Creating and searching a function signature"></a>Creating and searching a function signature</h2><p>To search a function in a binary we first have to create a signature of the function we want to search, radare has its own format of signature. All the functionality related to signatures can be found by <strong>z?</strong> command. Anyways to creating a function signature is very simple all you have to do is seek to the function and type <strong>zaf [function_name] [signature_name]</strong> this will generate the signature for the function with that name. For our example, there are two functions for which we need to create the signature:</p><ol><li><strong>zaf sub.7_1__700 config_func</strong>: this command creates the signature for the function which creates the configuration data structure which is used to find the addresses of the string of encrypted configuration, this will result in signature name <em>config_func</em>.</li><li><strong>zaf fcn.decrypt decrypt</strong>: this will create the signature for decryption function.</li></ol><p>Signatures can be saved to file with <strong>zos [filename]</strong> command and to reload the signature use <strong>zo [filename]</strong> command. We will later use this signature in our python script to search these functions start and end address.</p><h2 id="Searching-the-address-of-the-function-with-signatures"><a href="#Searching-the-address-of-the-function-with-signatures" class="headerlink" title="Searching the address of the function with signatures"></a>Searching the address of the function with signatures</h2><p>Now to search the signature you will have to use <strong>z/</strong> command and the resulting address can be found in <em>sign</em> flag space, address at which these functions are found are flagged as <strong>sign.bytes.[signature name]</strong>. To see the search results just switch to <em>sign</em> flag space by <strong>fs sign</strong> command and the use <strong>f</strong> command to list flag as the results. To get all the search result you can use the <strong>fj</strong> command to get all the address in json format will be used for our python script.</p><p>The next task is to get the start and end address of the function which is done by the function below. It returns start address, the address of instruction where we set the base address of the configuration data structure and end address of the function.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_decryption_func</span>():</span></span><br><span class="line">    func_sig = <span class="string">&#x27;./mirai_decrypt_func.sdb&#x27;</span></span><br><span class="line">    <span class="comment"># load the signature file</span></span><br><span class="line">    r.cmd(<span class="string">&#x27;zo &#x27;</span>+func_sig)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># search for siguature</span></span><br><span class="line">    func_srch_res = r.cmd(<span class="string">&#x27;z/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># select signature flag space</span></span><br><span class="line">    r.cmd(<span class="string">&#x27;fs sign&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get all the flags in signature flag space</span></span><br><span class="line">    func_srch_res = r.cmdj(<span class="string">&#x27;fj sign&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(func_srch_res) == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">&#x27;[-] Encryption function signature not found&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    print(<span class="string">&#x27;[+] Encryption function signature found&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the start address of the signature file</span></span><br><span class="line">    func_start_addr = func_srch_res[<span class="number">0</span>][<span class="string">&#x27;offset&#x27;</span>]</span><br><span class="line">    r.cmd(<span class="string">&#x27;s &#x27;</span>+<span class="built_in">str</span>(func_start_addr))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get function information</span></span><br><span class="line">    func_info = r.cmdj(<span class="string">&#x27;afij&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># calculate the function last instruction</span></span><br><span class="line">    func_end_addr = func_start_addr + func_info[<span class="string">&#x27;size&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># find the address of the instruction where we have to load</span></span><br><span class="line">    <span class="comment"># the base address of data structure, its the 9 instruction</span></span><br><span class="line">    <span class="comment"># from first instruction of the function</span></span><br><span class="line">    halt_addr = r.cmdj(<span class="string">&#x27;pdj 9&#x27;</span>)[-<span class="number">1</span>][<span class="string">&#x27;offset&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># reset the flag space to global flags or you won&#x27;t be able to</span></span><br><span class="line">    <span class="comment"># see any other search results , very important.</span></span><br><span class="line">    r.cmd(<span class="string">&#x27;fs *&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> func_start_addr, halt_addr, func_end_addr</span><br></pre></td></tr></table></figure><p>Similarly, there is another function which searches for the function which has the references for all the data structure.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_config_func</span>():</span></span><br><span class="line">    r.cmd(<span class="string">&#x27;fs sign&#x27;</span>)</span><br><span class="line">    func_srch_res = r.cmdj(<span class="string">&#x27;fj sign&#x27;</span>)</span><br><span class="line">    print(func_srch_res)</span><br><span class="line">    srch_res = <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> x : x[<span class="string">&#x27;name&#x27;</span>].find(<span class="string">&#x27;config_func&#x27;</span>) &gt; <span class="number">0</span>, func_srch_res))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(func_srch_res) == <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(srch_res) == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">&#x27;[-] Configuration function signature not found&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    print(<span class="string">&#x27;[+] Configuration function signature found&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    func_start_addr = srch_res[<span class="number">0</span>][<span class="string">&#x27;offset&#x27;</span>]</span><br><span class="line">    r.cmd(<span class="string">&#x27;s &#x27;</span>+<span class="built_in">str</span>(func_start_addr))</span><br><span class="line">    func_info = r.cmdj(<span class="string">&#x27;afij&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    func_end_addr = func_start_addr + func_info[<span class="string">&#x27;size&#x27;</span>]</span><br><span class="line">    r.cmd(<span class="string">&#x27;fs *&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> func_start_addr, func_end_addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># find function address in binary</span></span><br><span class="line">config_addr_start, config_addr_end = find_config_func()</span><br><span class="line">func_start_addr, addr_of_halt , func_end_addr = find_decryption_func()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>This completes our script, we have discovered the function address and used it will last two lines of code.</p><h2 id="Partial-code-emulation-take-away"><a href="#Partial-code-emulation-take-away" class="headerlink" title="Partial code emulation take away"></a>Partial code emulation take away</h2><p>In this experiment I have got into lots of trouble with running the emulation, so here are some of the debugging tips :</p><ol><li>Deep nested calls can have system calls which might not be emulated by radare which might hang up the execution.</li><li>The uninitialized global variable used inside of function might hang up the emulation.</li><li>Take care of byte ordering(Little/Big Endian) when setting up the structure on stack or else emulator might reference address outside its valid memory range.</li></ol><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This post ends the three part series of partial code emulation feature of radare, we used this feature to decrypt the configuration of Mirai malware and we also saw how to make the script more portable by removing the hard-coded address of the functions and replacing it by signature-based search approach. We also saw some of the technique we used to find the address of the encrypted string, the point of this exercise was to explore other capabilities of radare.</p></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Malware-Analysis/">Malware Analysis</a><a class="link-muted mr-2" rel="tag" href="/tags/Linux-Malware/">Linux Malware</a><a class="link-muted mr-2" rel="tag" href="/tags/radare2/">radare2</a></div></article></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2018/10/10/setting-up-windows-7-for-kernel-debugging/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Setting up Windows 7 Machine for Kernel Debugging</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2018/09/03/decrypting-mirai-configuration-with-radare2-part-1/"><span class="level-item">Decrypting Mirai configuration With radare2 (Part 1)</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config=function(){this.page.url="https://www.taintedbits.com/2018/09/15/decrypting-mirai-configuration-with-radare2-part-2/",this.page.identifier="2018/09/15/decrypting-mirai-configuration-with-radare2-part-2/"};!function(){var t=document,i=t.createElement("script");i.src="//taintedbits.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(i)}()</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen order-1"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Data-Reference-Search-Method"><span class="level-left"><span class="level-item">1</span><span class="level-item">Data Reference Search Method</span></span></a></li><li><a class="level is-mobile" href="#Assembly-Search-Method"><span class="level-left"><span class="level-item">2</span><span class="level-item">Assembly Search Method</span></span></a></li><li><a class="level is-mobile" href="#Creating-and-searching-a-function-signature"><span class="level-left"><span class="level-item">3</span><span class="level-item">Creating and searching a function signature</span></span></a></li><li><a class="level is-mobile" href="#Searching-the-address-of-the-function-with-signatures"><span class="level-left"><span class="level-item">4</span><span class="level-item">Searching the address of the function with signatures</span></span></a></li><li><a class="level is-mobile" href="#Partial-code-emulation-take-away"><span class="level-left"><span class="level-item">5</span><span class="level-item">Partial code emulation take away</span></span></a></li><li><a class="level is-mobile" href="#Conclusion"><span class="level-left"><span class="level-item">6</span><span class="level-item">Conclusion</span></span></a></li></ul></div></div><style>#toc .menu-list>li>a.is-active+.menu-list{display:block}#toc .menu-list>li>a+.menu-list{display:none}</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time datetime="2021-02-14T18:30:00.000Z">2021-02-15</time></p><p class="title"><a href="/2021/02/15/arm-architecture-webinar/">ARM Architecture and Shellcode Webinars</a></p><p class="categories"><a href="/categories/Binary-Exploitation/">Binary Exploitation</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2020-07-17T18:30:00.000Z">2020-07-18</time></p><p class="title"><a href="/2020/07/18/binary-exploitation-pwnable-tw-tcache-tear/">Binary Exploitation [pwnable.tw] - Tcache Tear</a></p><p class="categories"><a href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2020-07-11T18:30:00.000Z">2020-07-12</time></p><p class="title"><a href="/2020/07/12/binary-exploitation-pwnable-tw-caov/">Binary Exploitation [pwnable.tw] - CAOV</a></p><p class="categories"><a href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2020-07-10T18:30:00.000Z">2020-07-11</time></p><p class="title"><a href="/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/">Binary Exploitation [pwnable.tw] - Spirited Away</a></p><p class="categories"><a href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2020-07-04T18:30:00.000Z">2020-07-05</time></p><p class="title"><a href="/2020/07/05/binary-exploitation-pwnable-tw-realloc/">Binary Exploitation [pwnable.tw] - Realloc</a></p><p class="categories"><a href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Binary-Exploitation/"><span class="level-start"><span class="level-item">Binary Exploitation</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Brain-Logs/"><span class="level-start"><span class="level-item">Brain Logs</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/CTF-Writeups/"><span class="level-start"><span class="level-item">CTF Writeups</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/Exploitation/"><span class="level-start"><span class="level-item">Exploitation</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/IoT/"><span class="level-start"><span class="level-item">IoT</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Machine-Learning/"><span class="level-start"><span class="level-item">Machine Learning</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Malware-Analysis/"><span class="level-start"><span class="level-item">Malware Analysis</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/NLP/"><span class="level-start"><span class="level-item">NLP</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Reverse-Engineering/"><span class="level-start"><span class="level-item">Reverse Engineering</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ACS712/"><span class="tag">ACS712</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Arduino/"><span class="tag">Arduino</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Bare-Metal/"><span class="tag">Bare-Metal</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Chat-Bots/"><span class="tag">Chat Bots</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Classification/"><span class="tag">Classification</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Data-Wrangling/"><span class="tag">Data Wrangling</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Dev/"><span class="tag">Dev</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Dropper/"><span class="tag">Dropper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ESP8266/"><span class="tag">ESP8266</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Editor/"><span class="tag">Editor</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Emacs/"><span class="tag">Emacs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Exploitation/"><span class="tag">Exploitation</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GandCrab/"><span class="tag">GandCrab</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Grey-Energy/"><span class="tag">Grey Energy</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Heap-Exploitation/"><span class="tag">Heap Exploitation</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kernel-Debugging/"><span class="tag">Kernel Debugging</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">15</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux-Malware/"><span class="tag">Linux Malware</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Malware-Analysis/"><span class="tag">Malware Analysis</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ROP/"><span class="tag">ROP</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Regression/"><span class="tag">Regression</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reverse-Engineering/"><span class="tag">Reverse Engineering</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Visualization/"><span class="tag">Visualization</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WarGames/"><span class="tag">WarGames</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows-Malware/"><span class="tag">Windows Malware</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows-Reversing/"><span class="tag">Windows Reversing</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/glibc/"><span class="tag">glibc</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/javascript-obfuscation/"><span class="tag">javascript obfuscation</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable/"><span class="tag">pwnable</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable-kr/"><span class="tag">pwnable-kr</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable-tw/"><span class="tag">pwnable-tw</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/radare2/"><span class="tag">radare2</span><span class="tag">4</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/logo-header.png" alt="Tainted Bits" height="28"></a><p class="is-size-7"><span>&copy; 2021 D3xt3r</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by-sa/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Subscribe" href="https://mailchi.mp/d744c1f04904/taintedbits"><i class="fa fa-envelope"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/0xd3xt3r"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en")</script><script>var IcarusThemeSettings={article:{highlight:{clipboard:!0,fold:"unfolded"}}}</script><script src="/js/column.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load",()=>{"function"==typeof $.fn.lightGallery&&$(".article").lightGallery({selector:".gallery-item"}),"function"==typeof $.fn.justifiedGallery&&($(".justified-gallery > p > .gallery-item").length&&$(".justified-gallery > p > .gallery-item").unwrap(),$(".justified-gallery").justifiedGallery())})</script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now</a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load",(function(){outdatedBrowser({bgColor:"#f25648",color:"#ffffff",lowerThan:"object-fit"})}))</script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener("DOMContentLoaded",(function(){loadInsight({contentUrl:"/content.json"},{hint:"Type something...",untitled:"(Untitled)",posts:"Posts",pages:"Pages",categories:"Categories",tags:"Tags"})}))</script></body></html>